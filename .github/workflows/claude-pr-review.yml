name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  issue_comment:
    types: [created]

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && !github.event.pull_request.draft) ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude review'))

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Review PR with Claude
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this pull request using the @reviewer agent.

            ## Instructions
            1. Analyze all changed files in this PR
            2. Check against the standards in CLAUDE.md
            3. Provide structured feedback with:
               - Critical issues (must fix before merge)
               - Warnings (should fix)
               - Suggestions (nice to have)
               - Positive observations

            4. Post a review comment with your findings
            5. If there are critical issues, request changes
            6. If no critical issues, approve the PR

            Be constructive and specific. Reference line numbers.

          allowed_tools: |
            Read,Glob,Grep,Bash

          max_turns: 15

      - name: Add review label
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['claude-reviewed']
            });
