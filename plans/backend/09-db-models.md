# 09 - SQLAlchemy Models & Migrations

## Overview

Define PostgreSQL database models using SQLAlchemy 2.0 async, with soft deletes and sync-friendly timestamps.

---

## Base Model

### app/models/base.py

```python
import uuid
from datetime import datetime
from sqlalchemy import DateTime, Boolean, func
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy.dialects.postgresql import UUID

from app.database import Base


class SyncableBase(Base):
    """Base class for all syncable models."""

    __abstract__ = True

    id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
    )
    client_id: Mapped[str | None] = mapped_column(
        index=True,
        comment="WatermelonDB ID from client",
    )
    is_deleted: Mapped[bool] = mapped_column(
        Boolean,
        default=False,
        index=True,
        comment="Soft delete flag for sync",
    )
    last_modified: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
        onupdate=func.now(),
        index=True,
        comment="For sync queries",
    )
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
    )
```

---

## Device Model

### app/models/device.py

```python
from datetime import datetime
from sqlalchemy import String, DateTime
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.models.base import Base
import uuid
from sqlalchemy.dialects.postgresql import UUID


class Device(Base):
    """Registered device for authentication."""

    __tablename__ = "devices"

    id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        primary_key=True,
        default=uuid.uuid4,
    )
    device_id: Mapped[str] = mapped_column(
        String(36),
        unique=True,
        index=True,
        comment="UUID generated by client app",
    )
    user_id: Mapped[uuid.UUID | None] = mapped_column(
        UUID(as_uuid=True),
        nullable=True,
        comment="Future: link to user account",
    )
    last_seen: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
    )
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
    )

    # Relationships
    games: Mapped[list["Game"]] = relationship(back_populates="device")
```

---

## Game Model

### app/models/game.py

```python
from datetime import datetime
from sqlalchemy import String, Integer, DateTime, ForeignKey, Enum
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.dialects.postgresql import UUID
import uuid
import enum

from app.models.base import SyncableBase


class GameStatus(str, enum.Enum):
    ACTIVE = "active"
    COMPLETED = "completed"


class Game(SyncableBase):
    """A lookyswappy game session."""

    __tablename__ = "games"

    device_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("devices.id"),
        index=True,
    )
    name: Mapped[str | None] = mapped_column(String(100))
    target_score: Mapped[int] = mapped_column(Integer, default=100)
    status: Mapped[GameStatus] = mapped_column(
        Enum(GameStatus),
        default=GameStatus.ACTIVE,
    )
    winner_id: Mapped[uuid.UUID | None] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("game_players.id"),
        nullable=True,
    )
    started_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        server_default=func.now(),
    )
    ended_at: Mapped[datetime | None] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
    )

    # Relationships
    device: Mapped["Device"] = relationship(back_populates="games")
    players: Mapped[list["GamePlayer"]] = relationship(
        back_populates="game",
        cascade="all, delete-orphan",
    )
    rounds: Mapped[list["Round"]] = relationship(
        back_populates="game",
        cascade="all, delete-orphan",
    )
```

---

## GamePlayer Model

### app/models/player.py

```python
from sqlalchemy import String, Integer, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.dialects.postgresql import UUID
import uuid

from app.models.base import SyncableBase


class GamePlayer(SyncableBase):
    """A player in a specific game."""

    __tablename__ = "game_players"

    game_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("games.id"),
        index=True,
    )
    name: Mapped[str] = mapped_column(String(50))
    position: Mapped[int] = mapped_column(Integer, comment="Display order")
    current_total: Mapped[int] = mapped_column(
        Integer,
        default=0,
        comment="Cached cumulative score",
    )

    # Relationships
    game: Mapped["Game"] = relationship(back_populates="players")
    scores: Mapped[list["Score"]] = relationship(
        back_populates="player",
        cascade="all, delete-orphan",
    )
```

---

## Round Model

### app/models/round.py

```python
from datetime import datetime
from sqlalchemy import Integer, DateTime, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.dialects.postgresql import UUID
import uuid

from app.models.base import SyncableBase


class Round(SyncableBase):
    """A single round in a game."""

    __tablename__ = "rounds"

    game_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("games.id"),
        index=True,
    )
    round_number: Mapped[int] = mapped_column(Integer)
    caller_id: Mapped[uuid.UUID | None] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("game_players.id"),
        nullable=True,
        comment="Player who called lookyswappy",
    )

    # Relationships
    game: Mapped["Game"] = relationship(back_populates="rounds")
    scores: Mapped[list["Score"]] = relationship(
        back_populates="round",
        cascade="all, delete-orphan",
    )
```

---

## Score Model

### app/models/score.py

```python
from sqlalchemy import Integer, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.dialects.postgresql import UUID
import uuid

from app.models.base import SyncableBase


class Score(SyncableBase):
    """A player's score for a single round."""

    __tablename__ = "scores"

    round_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("rounds.id"),
        index=True,
    )
    player_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        ForeignKey("game_players.id"),
        index=True,
    )
    raw_score: Mapped[int] = mapped_column(
        Integer,
        comment="Score before bonus",
    )
    bonus_applied: Mapped[int] = mapped_column(
        Integer,
        default=0,
        comment="-25 or 0",
    )
    final_score: Mapped[int] = mapped_column(
        Integer,
        comment="raw_score + bonus_applied",
    )
    total_after: Mapped[int] = mapped_column(
        Integer,
        comment="Running total after this round",
    )

    # Relationships
    round: Mapped["Round"] = relationship(back_populates="scores")
    player: Mapped["GamePlayer"] = relationship(back_populates="scores")
```

---

## Models __init__.py

### app/models/__init__.py

```python
from app.models.base import Base, SyncableBase
from app.models.device import Device
from app.models.game import Game, GameStatus
from app.models.player import GamePlayer
from app.models.round import Round
from app.models.score import Score

__all__ = [
    "Base",
    "SyncableBase",
    "Device",
    "Game",
    "GameStatus",
    "GamePlayer",
    "Round",
    "Score",
]
```

---

## Initial Migration

```bash
# Generate migration
alembic revision --autogenerate -m "initial schema"

# Apply migration
alembic upgrade head
```

### Expected migration creates:

```sql
CREATE TABLE devices (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id VARCHAR(36) UNIQUE NOT NULL,
    user_id UUID,
    last_seen TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE games (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    client_id VARCHAR,
    device_id UUID REFERENCES devices(id),
    name VARCHAR(100),
    target_score INTEGER DEFAULT 100,
    status VARCHAR DEFAULT 'active',
    winner_id UUID,
    started_at TIMESTAMPTZ DEFAULT NOW(),
    ended_at TIMESTAMPTZ,
    is_deleted BOOLEAN DEFAULT FALSE,
    last_modified TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE game_players (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    client_id VARCHAR,
    game_id UUID REFERENCES games(id),
    name VARCHAR(50) NOT NULL,
    position INTEGER NOT NULL,
    current_total INTEGER DEFAULT 0,
    is_deleted BOOLEAN DEFAULT FALSE,
    last_modified TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE rounds (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    client_id VARCHAR,
    game_id UUID REFERENCES games(id),
    round_number INTEGER NOT NULL,
    caller_id UUID REFERENCES game_players(id),
    is_deleted BOOLEAN DEFAULT FALSE,
    last_modified TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE scores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    client_id VARCHAR,
    round_id UUID REFERENCES rounds(id),
    player_id UUID REFERENCES game_players(id),
    raw_score INTEGER NOT NULL,
    bonus_applied INTEGER DEFAULT 0,
    final_score INTEGER NOT NULL,
    total_after INTEGER NOT NULL,
    is_deleted BOOLEAN DEFAULT FALSE,
    last_modified TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for sync queries
CREATE INDEX ix_games_last_modified ON games(last_modified);
CREATE INDEX ix_games_device_id ON games(device_id);
CREATE INDEX ix_game_players_last_modified ON game_players(last_modified);
CREATE INDEX ix_rounds_last_modified ON rounds(last_modified);
CREATE INDEX ix_scores_last_modified ON scores(last_modified);
```

---

## Tasks

- [ ] Create base.py with SyncableBase
- [ ] Create all model files
- [ ] Create models/__init__.py
- [ ] Generate initial migration
- [ ] Verify migration SQL looks correct
- [ ] Apply migration to local database
- [ ] Test basic CRUD operations
